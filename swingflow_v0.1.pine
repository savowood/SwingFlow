//@version=5
// ============================================================================
// SWINGFLOW v0.1
// Advanced Pullback Trading Strategy
// 
// Support the developer: https://buymeacoffee.com/savowood
// ============================================================================

strategy("SwingFlow v0.1", 
         shorttitle="SwingFlow v0.1", 
         overlay=true, 
         initial_capital=100000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=2)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Trading Style Selection
tradingStyle = input.string("Swing", "Trading Style", options=["Intraday", "Swing", "Medium-Term", "Long-Term"], group="Trading Style")

// EMA Settings (9/20/180 Setup)
ema9Length = input.int(9, "Fast EMA (9)", minval=1, group="EMAs")
ema20Length = input.int(20, "Medium EMA (20)", minval=1, group="EMAs")
ema180Length = input.int(180, "Slow EMA (180)", minval=1, group="EMAs")
useEmaFilter = input.bool(true, "Require Price Above 9/20/180 EMA Stack", group="EMAs")

// VWAP Settings
useVwap = input.bool(true, "Use VWAP", group="VWAP")
vwapPullbackType = input.string("Touch", "VWAP Pullback Type", options=["Touch", "Cross Below Then Above", "Within Range"], group="VWAP")
vwapRangePercent = input.float(0.3, "VWAP Range % (for Within Range)", minval=0.1, maxval=5, step=0.1, group="VWAP")

// MACD Settings
macdFast = input.int(12, "MACD Fast Length", minval=1, group="MACD")
macdSlow = input.int(26, "MACD Slow Length", minval=1, group="MACD")
macdSignal = input.int(9, "MACD Signal Length", minval=1, group="MACD")
useMacdConfirmation = input.bool(true, "Require MACD Bullish", group="MACD")
requireMacdCrossover = input.bool(true, "Require Recent MACD Crossover", group="MACD")

// Additional Indicators (Optional)
useRsi = input.bool(true, "Use RSI Filter", group="Additional Filters")
rsiLength = input.int(14, "RSI Length", minval=1, group="Additional Filters")
rsiOversold = input.int(40, "RSI Oversold Level", minval=1, maxval=50, group="Additional Filters")
rsiOverbought = input.int(65, "RSI Overbought Level", minval=50, maxval=99, group="Additional Filters")

useStochastic = input.bool(false, "Use Stochastic Filter", group="Additional Filters")
stochLength = input.int(14, "Stochastic %K Length", minval=1, group="Additional Filters")
stochSmooth = input.int(3, "Stochastic %K Smoothing", minval=1, group="Additional Filters")
stochOversold = input.int(20, "Stochastic Oversold", minval=1, maxval=50, group="Additional Filters")

useBollinger = input.bool(false, "Use Bollinger Bands Filter", group="Additional Filters")
bbLength = input.int(20, "Bollinger Length", minval=1, group="Additional Filters")
bbStdDev = input.float(2.0, "Bollinger Std Dev", minval=0.5, maxval=5, step=0.1, group="Additional Filters")

// Volume Filter
useVolumeFilter = input.bool(true, "Require Above Average Volume", group="Volume")
volumeMultiplier = input.float(1.5, "Volume Multiplier", minval=0.5, maxval=5, step=0.1, group="Volume")
volumeAvgLength = input.int(20, "Volume Average Length", minval=1, group="Volume")

// Risk Management
riskRewardRatio = input.float(3.0, "Risk:Reward Ratio", minval=0.5, maxval=10, step=0.5, group="Risk Management")
stopLossType = input.string("ATR-Based", "Stop Loss Type", options=["ATR-Based", "Percentage", "Recent Low"], group="Risk Management")
stopLossPercent = input.float(2.0, "Stop Loss % (if Percentage)", minval=0.1, maxval=10, step=0.1, group="Risk Management")
atrLength = input.int(14, "ATR Length", minval=1, group="Risk Management")
atrMultiplier = input.float(2.0, "ATR Multiplier for Stop", minval=0.5, maxval=5, step=0.25, group="Risk Management")
useTrailingStop = input.bool(true, "Use Trailing Stop", group="Risk Management")
trailStopATRMult = input.float(2.5, "Trailing Stop ATR Multiplier", minval=0.5, maxval=5, step=0.25, group="Risk Management")

// Position Sizing
positionSizePercent = input.float(100, "Position Size (% of Equity)", minval=1, maxval=100, step=1, group="Position Sizing")
maxPositions = input.int(1, "Max Concurrent Positions", minval=1, maxval=10, group="Position Sizing")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// EMAs (9/20/180 Setup)
ema9 = ta.ema(close, ema9Length)
ema20 = ta.ema(close, ema20Length)
ema180 = ta.ema(close, ema180Length)

// VWAP
vwapValue = ta.vwap(close)

// MACD
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)

// ATR for volatility-based stops
atr = ta.atr(atrLength)

// RSI
rsi = ta.rsi(close, rsiLength)

// Stochastic
stochK = ta.stoch(close, high, low, stochLength)
stochD = ta.sma(stochK, stochSmooth)

// Bollinger Bands
bbBasis = ta.sma(close, bbLength)
bbDev = bbStdDev * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// Volume
avgVolume = ta.sma(volume, volumeAvgLength)

// Price Action - Bullish Candle Patterns
isBullishEngulfing = close > open and close[1] < open[1] and close > open[1] and open < close[1]
isHammer = (high - low) > 3 * (close - open) and (close - low) / (.001 + high - low) > 0.6 and (open - low) / (.001 + high - low) > 0.6
isBullishCandle = close > open and (close - open) > (high - low) * 0.6

// ============================================================================
// TRADING LOGIC - PULLBACK DETECTION
// ============================================================================

// Timeframe-specific parameters
var int lookbackBars = switch tradingStyle
    "Intraday" => 5
    "Swing" => 10
    "Medium-Term" => 15
    "Long-Term" => 20
    => 10

// EMA Stack Filter (price above all EMAs in uptrend)
emaStackBullish = ema9 > ema20 and ema20 > ema180 and close > ema9
emaFilter = useEmaFilter ? emaStackBullish : true

// VWAP Pullback Conditions
vwapPullbackTouch = low <= vwapValue and close > vwapValue
vwapPullbackCross = ta.crossover(close, vwapValue) and low[1] < vwapValue[1]
vwapPullbackRange = close > vwapValue * (1 - vwapRangePercent/100) and close < vwapValue * (1 + vwapRangePercent/100)

vwapCondition = not useVwap or (vwapPullbackType == "Touch" and vwapPullbackTouch) or (vwapPullbackType == "Cross Below Then Above" and vwapPullbackCross) or (vwapPullbackType == "Within Range" and vwapPullbackRange)

// MACD Confirmation (bullish momentum)
macdBullish = macdLine > signalLine and macdHist > 0
macdRecentCross = ta.barssince(ta.crossover(macdLine, signalLine)) <= 5
macdCondition = not useMacdConfirmation or (requireMacdCrossover ? (macdBullish and macdRecentCross) : macdBullish)

// RSI Condition (recovery from oversold or not overbought)
rsiCondition = not useRsi or (rsi > rsiOversold and rsi < rsiOverbought)

// Stochastic Condition (recovery from oversold)
stochCondition = not useStochastic or (stochK > stochOversold and stochK < 80)

// Bollinger Bands Condition (bounce from lower band)
bbBounce = low <= bbLower and close > bbLower
bbCondition = not useBollinger or bbBounce

// Volume Condition
volumeCondition = not useVolumeFilter or volume > avgVolume * volumeMultiplier

// Price Action Confirmation
priceActionBullish = isBullishEngulfing or isHammer or isBullishCandle

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================

// Detect pullback: price pulled back to key level and showing signs of reversal
recentHigh = ta.highest(high, lookbackBars)
isPullback = high < recentHigh and close > open  // Lower high but bullish close

// Long Entry Signal
longCondition = isPullback and emaFilter and vwapCondition and macdCondition and rsiCondition and stochCondition and bbCondition and volumeCondition and priceActionBullish and strategy.position_size == 0

// ============================================================================
// POSITION MANAGEMENT
// ============================================================================

var float entryPrice = na
var float stopLoss = na
var float takeProfit = na
var float trailStop = na

if longCondition
    entryPrice := close
    
    // Calculate Stop Loss
    if stopLossType == "ATR-Based"
        stopLoss := entryPrice - (atr * atrMultiplier)
    else if stopLossType == "Percentage"
        stopLoss := entryPrice * (1 - stopLossPercent/100)
    else  // Recent Low
        stopLoss := ta.lowest(low, lookbackBars) * 0.995  // 0.5% below recent low
    
    // Calculate Take Profit based on Risk:Reward
    riskAmount = entryPrice - stopLoss
    takeProfit := entryPrice + (riskAmount * riskRewardRatio)
    
    // Initialize trailing stop
    trailStop := entryPrice - (atr * trailStopATRMult)
    
    // Enter Long Position
    strategy.entry("Long", strategy.long, qty=positionSizePercent/100)

// Update Trailing Stop
if strategy.position_size > 0 and useTrailingStop
    newTrailStop = close - (atr * trailStopATRMult)
    trailStop := math.max(trailStop, newTrailStop)

// Exit Conditions
if strategy.position_size > 0
    if useTrailingStop
        strategy.exit("Exit Long", "Long", stop=trailStop, limit=takeProfit)
    else
        strategy.exit("Exit Long", "Long", stop=stopLoss, limit=takeProfit)

// ============================================================================
// PLOTTING
// ============================================================================

// Plot EMAs
plot(ema9, "EMA 9", color=color.new(color.blue, 0), linewidth=2)
plot(ema20, "EMA 20", color=color.new(color.orange, 0), linewidth=2)
plot(ema180, "EMA 180", color=color.new(color.red, 0), linewidth=2)

// Plot VWAP
plot(useVwap ? vwapValue : na, "VWAP", color=color.new(color.purple, 0), linewidth=2, style=plot.style_circles)

// Plot Bollinger Bands
plot(useBollinger ? bbUpper : na, "BB Upper", color=color.new(color.gray, 70))
plot(useBollinger ? bbLower : na, "BB Lower", color=color.new(color.gray, 70))
plot(useBollinger ? bbBasis : na, "BB Basis", color=color.new(color.gray, 50))

// Plot Entry/Exit Labels with Clear Text
plotshape(longCondition, "LONG ENTRY", shape.labelup, location.belowbar, 
          color=color.new(color.green, 0), text="LONG\nENTRY", textcolor=color.white, size=size.normal)

// Plot exit labels
exitSignal = strategy.position_size[1] > 0 and strategy.position_size == 0
plotshape(exitSignal and close > strategy.opentrades.entry_price(0)[1], "EXIT PROFIT", shape.labeldown, location.abovebar,
          color=color.new(color.green, 0), text="EXIT\nPROFIT", textcolor=color.white, size=size.normal)
plotshape(exitSignal and close < strategy.opentrades.entry_price(0)[1], "EXIT LOSS", shape.labeldown, location.abovebar,
          color=color.new(color.red, 0), text="EXIT\nLOSS", textcolor=color.white, size=size.normal)

// Plot Stop Loss and Take Profit lines
plot(strategy.position_size > 0 ? (useTrailingStop ? trailStop : stopLoss) : na, 
     "Stop Loss", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)
plot(strategy.position_size > 0 ? takeProfit : na, 
     "Take Profit", color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr)

// Add price labels for active positions
if strategy.position_size > 0 and barstate.islast
    entryPriceLabel = label.new(bar_index, entryPrice, 
                                 text="Entry: " + str.tostring(entryPrice, "#.##"),
                                 style=label.style_label_left, color=color.blue, textcolor=color.white, size=size.normal)
    stopLabel = label.new(bar_index, useTrailingStop ? trailStop : stopLoss,
                          text="Stop: " + str.tostring(useTrailingStop ? trailStop : stopLoss, "#.##"),
                          style=label.style_label_left, color=color.red, textcolor=color.white, size=size.normal)
    targetLabel = label.new(bar_index, takeProfit,
                            text="Target: " + str.tostring(takeProfit, "#.##"),
                            style=label.style_label_left, color=color.green, textcolor=color.white, size=size.normal)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(longCondition, title="Pullback Entry Signal", 
               message="SwingFlow: LONG Entry Signal Detected!")

// ============================================================================
// DASHBOARD (Optional Info)
// ============================================================================

var table dashboard = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), frame_color=color.new(color.blue, 50), frame_width=1)

if barstate.islast
    table.cell(dashboard, 0, 0, "Trading Style", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 0, tradingStyle, text_color=color.yellow, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 1, "EMA Stack", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 1, emaStackBullish ? "✓ Bullish" : "✗ Bearish", 
               text_color=emaStackBullish ? color.lime : color.red, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 2, "VWAP Signal", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 2, vwapCondition ? "✓ Active" : "✗ Waiting", 
               text_color=vwapCondition ? color.lime : color.orange, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 3, "MACD", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 3, macdBullish ? "✓ Bullish" : "✗ Bearish", 
               text_color=macdBullish ? color.lime : color.red, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 4, "RSI", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 4, str.tostring(math.round(rsi, 1)), 
               text_color=color.white, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 5, "Volume", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 5, volumeCondition ? "✓ Strong" : "✗ Weak", 
               text_color=volumeCondition ? color.lime : color.orange, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 6, "Position", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 6, strategy.position_size > 0 ? "LONG" : "None", 
               text_color=strategy.position_size > 0 ? color.lime : color.gray, bgcolor=color.new(color.blue, 90))
    
    table.cell(dashboard, 0, 7, "R:R Ratio", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 7, str.tostring(riskRewardRatio) + ":1", 
               text_color=color.yellow, bgcolor=color.new(color.blue, 90))
